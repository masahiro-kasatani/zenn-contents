---
title: "Terraformの型とループ処理を理解する"
emoji: "🎉"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [terraform]
published: false
---

## 本記事の目的
* Terraformの型について整理する
* なんとなく書いているTerraformのループ処理を理解する
* Terraformのループ処理の使い所、使い分けについて理解する

Terraformの繰り返し処理は可読性がイマイチで、コピペで乗り越えている人も多いかと思います。本記事を読めば、その状態を脱却できるはずです。TerraformをDRYに書くために必須のスキルなのでぜひ一読してみてください。

## Terraformの型について

型についての理解が不十分である場合、ループ処理の理解が難しくなります。
前提知識として知っておく必要があるため、ざっくりと説明します。
もちろん、知っている方は読み飛ばしてもらって結構です。

### Lists/Tuples/Sets

すべて、`[ ]`で囲まれた一連の値であり、下記の違いがあります。

* `list`: 要素が同じ型で、順序のある配列
    * 例: `["foo", "foo", "baz"]`
* `tuple`: 要素が異なる型で、順序のある配列
    * 例: `["foo", "foo", "baz", 1, true]`
* `set`: 要素が同じ型で、順序のない集合（順序がないため、重複が許されない）
    * 例: `["foo", "bar", "baz"]`

### Maps/Objects

ともに、`{ }`で囲まれた一連のkey=valueであり、下記の違いがあります。

* `map`: 1つの型のvalueでのみ表現可能
    * ただし、型を `map(string)`としておけば、`number`や`bool`も暗黙的に型変換されるため、含めることが可能になります

例:
```hcl
variable "map" {
  type        = map(string)
  description = "サンプルマップ"
  default     = { a = "hoge", b = 1, c = true }
}
```

* `object`: 複数の型のvalueで表現可能
    * keyの名前とvalueの型を定義する必要があります

例:
```hcl
variable "object" {
  type = object({
    a = list(string)
    b = number
    c = bool
  })
  description = "サンプルオブジェクト"
  default = { a = ["hoge", "fuga"], b = 1, c = true }
}
```

### any についての補足
`map(any)`なら`object`のように扱えるのでは？と思う方もいるかもしれません。
実際に試してもらったら分かりますが、うまくいきません。

なぜなら、実は`any`は**単一の型でのみ機能するワイルドカード**だからです。
…で、実際に複数のデータ型が入った場合は、やはりstringに変換されるため、`map(any)`は`map(string)`と同じと思って差し支えないと思います。
（ただし、実際に色々な型が入ると想定しているのであれば`map(any)`と定義しておいた方が、モジュールの利用者や他の開発者にとって親切ですね）

:::message
**念の為の補足**
`map`のvalueが配列や集合などに対応していないわけではありません。
リストのマップ：`map(list(any))`やマップのマップ：`map(map(any))`も当然作れます。
ただし、この場合、リストのマップのvalueはすべて`list(any)`でないといけないし、マップのマップのvalueはすべて`map(any)`でないといけないということです。
:::

### 参考
本章に関するより詳しい内容は公式のドキュメントに記載されているので、参考にしてください。

https://developer.hashicorp.com/terraform/language/expressions/types
https://developer.hashicorp.com/terraform/language/expressions/type-constraints

## ループ処理
Terraformの型について整理できたところで、本題のループ処理を見ていきます。

### for

`for`は式であり、入出力があります。
* 入力として、`list`, `set`, `tuple`, `map`, `object`を受け付けます
* 出力として、`[ for ]`は `tuple` を、`{ for }`は `object` を返します
    * `[ ]`と`{ }`は前章で確認したとおりですね。

具体例として、下記のようなlistがあった場合、
```hcl
locals {
  list = ["foo", "bar", "baz"]
}
```
`tuple`の生成
```sh
echo '[for s in local.list : upper(s)]' | terraform console
[
  "FOO",
  "BAR",
  "BAZ",
]
```
`object`の生成
```sh
echo '{ for s in local.list : s => upper(s) }' | terraform console
{
  "bar" = "BAR"
  "baz" = "BAZ"
  "foo" = "FOO"
}
```
のようになります。

`:`の右辺が出力で、keyとvalueを出力する場合は、`<OUTPUT_KEY> => <OUTPUT_VALUE>`の形になります。

正直なところ、`for`単体ではあまり出番がなく、次に説明する`for_each`との組み合わせでよく使います。

#### 参考
https://developer.hashicorp.com/terraform/language/expressions/for


### for_each

`for_each`はメタ引数と呼ばれるもので、`resource`や`module`ブロック内で定義できます。
定義することで、`resource`や`module`の動作を変更できます。
具体的には、`for_each`を使うことで、1つの`resource`ブロックで、複数リソースの定義が可能となります。

```hcl
locals {
  name_list = ["hoge", "fuga"]
}
resource "aws_iam_user" "example" {
  for_each = toset(local.name_list)
  name     = each.value
}
```

terraform plan実行
```
# aws_iam_user.example["fuga"] will be created
+ resource "aws_iam_user" "example" {
    + arn           = (known after apply)
    + force_destroy = false
    + id            = (known after apply)
    + name          = "fuga"
    + path          = "/"
    + tags_all      = (known after apply)
    + unique_id     = (known after apply)
  }
# aws_iam_user.example["hoge"] will be created
+ resource "aws_iam_user" "example" {
    + arn           = (known after apply)
    + force_destroy = false
    + id            = (known after apply)
    + name          = "hoge"
    + path          = "/"
    + tags_all      = (known after apply)
    + unique_id     = (known after apply)
  }
```

:::message
`for_each`が受け取れる型は`map`か`set`であるため、`toset()`を
たとえ重複がなくても、local valueの配列は`tuple`になります。
:::

https://github.com/terraform-aws-modules/terraform-aws-vpc/blob/78f2845ee92364038780893e8d2107d692a163d3/main.tf#L1145-L1162

#### 参考
https://developer.hashicorp.com/terraform/language/meta-arguments/for_each

### count

countはループ処理での利用は非推奨です。前述した`for_each`を使いましょう。
非推奨な理由は、下記の記事が具体例もあって、簡潔で分かりやすいです。
https://tellme.tokyo/post/2022/06/12/terraform-count-for-each/
countの使い所はほぼ一択で、リソース作成のON・OFFで使用します。

## まとめ
間違い等あればご指摘お願いします。
また、本記事が役に立ちましたら、♡をポチッとお願いします。
以上です。